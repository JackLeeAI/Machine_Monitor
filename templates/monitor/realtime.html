{% extends "base.html" %}
{% block title %}实时监控{% endblock %}
{% block content %}
<div class="page-header">
    <h2>设备实时状态监控</h2>
</div>
<div class="filter-bar">
    <select id="workshop-filter" onchange="filterEquipment()">
        <option value="">所有车间</option>
        {% for workshop in workshops %}
        <option value="{{ workshop.id }}">{{ workshop.name }}</option>
        {% endfor %}
    </select>
    <select id="state-filter" onchange="filterEquipment()">
        <option value="">所有状态</option>
        <option value="在线">在线</option>
        <option value="离线">离线</option>
    </select>
    <select id="use-state-filter" onchange="filterEquipment()">
        <option value="">所有使用状态</option>
        <option value="在用">在用</option>
        <option value="在库">在库</option>
    </select>
</div>
<div class="equipment-grid">
    {% for eq in equipments %}
    <div class="equipment-card {{ eq.online_status.lower() }}" data-workshop="{{ eq.pos_id }}" data-online="{{ eq.online_status }}" data-use="{{ eq.use_state }}">
        <input type="hidden" class="equipment-id" value="{{ eq.id }}">
        <div class="card-header">
            <h3>{{ eq.name }}</h3>
            <span class="status-badge {{ eq.online_status.lower() }}">{{ eq.online_status }}</span>
        </div>
        <div class="card-body">
            <p><strong>设备编码：</strong>{{ eq.equip_code }}</p>
            <p><strong>安装车间：</strong>{{ eq.workshop_name}}</p>
            <p><strong>负责人：</strong>{{ eq.person_name }}</p>
            <p><strong>使用状态：</strong>{{ eq.use_state }}</p>
            <p><strong>最后心跳：</strong>{{ eq.last_heartbeat.strftime('%Y-%m-%d %H:%M:%S') if eq.last_heartbeat else '无' }}</p>
        </div>
        <div class="card-footer">
            <a href="{{ url_for('base_info.equipment_detail', eq_id=eq.id) }}" class="btn-detail">查看详情</a>
        </div>
    </div>
{% endfor %}
</div>

<!-- 分页控件 -->
{% if total_pages > 1 %}
<div class="pagination-container">
    <div class="pagination">
        <!-- 上一页按钮 -->
        {% if page > 1 %}
        <a href="{{ url_for('monitor.realtime', page=page-1) }}" class="page-link">&laquo; 上一页</a>
        {% else %}
        <a href="#" class="page-link disabled">&laquo; 上一页</a>
        {% endif %}

        <!-- 页码导航 -->
        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <a href="#" class="page-link active">{{ p }}</a>
            {% elif p <= 3 or (p >= page - 2 and p <= page + 2) or p >= total_pages - 2 %}
            <a href="{{ url_for('monitor.realtime', page=p) }}" class="page-link">{{ p }}</a>
            {% elif p == 4 or p == total_pages - 3 %}
            <span class="page-link ellipsis">...</span>
            {% endif %}
        {% endfor %}

        <!-- 下一页按钮 -->
        {% if page < total_pages %}
        <a href="{{ url_for('monitor.realtime', page=page+1) }}" class="page-link">下一页 &raquo;</a>
        {% else %}
        <a href="#" class="page-link disabled">下一页 &raquo;</a>
        {% endif %}
    </div>
    <div class="pagination-info">
        第 {{ page }}/{{ total_pages }} 页，共 {{ equipment_count }} 个设备
    </div>
</div>
{% endif %}
{% endblock %}
{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
<script>
// 设备筛选功能
function filterEquipment() {
    const workshopId = document.getElementById('workshop-filter').value;
    const onlineState = document.getElementById('state-filter').value;
    const useState = document.getElementById('use-state-filter').value;
    const cards = document.querySelectorAll('.equipment-card');

    cards.forEach(card => {
        let show = true;

        if (workshopId) {
            show = card.getAttribute('data-workshop') === workshopId;
        }
        if (onlineState && show) {
            show = card.getAttribute('data-online') === onlineState;
        }
        if (useState && show) {
            show = card.getAttribute('data-use') === useState;
        }

        card.style.display = show ? 'block' : 'none';
    });
}

// WebSocket 连接和心跳发送
const socket = io();

// 调试：监听WebSocket连接状态
socket.on('connect', () => {
    console.log('WebSocket连接成功！');
    
    // 连接成功后立即发送一次心跳
    sendHeartbeatForAllEquipments();
});

socket.on('disconnect', () => {
    console.log('WebSocket连接断开！');
});

socket.on('connect_error', (error) => {
    console.error('WebSocket连接错误：', error);
});

// 获取页面上所有设备的ID
const equipmentIds = [];

// 调试：查看所有可能的设备卡片元素
console.log('页面中所有的div元素：', document.querySelectorAll('div').length);

// 使用正确的选择器查找设备卡片（在模板中使用的是class="equipment-card"）
const cards = document.querySelectorAll('.equipment-card');
console.log('使用.equipment-card选择器找到的元素数量：', cards.length);

// 为每个设备卡片添加设备ID属性，方便直接获取
cards.forEach((card, index) => {
    // 调试：查看卡片的类名
    console.log(`卡片${index+1}的类名：`, card.className);
    
    // 检查卡片是否包含设备信息
    const title = card.querySelector('h3');
    if (title) {
        console.log(`卡片${index+1}的标题：`, title.textContent);
    }
    
    // 直接从隐藏字段获取设备ID（更可靠的方式）
    const equipmentIdInput = card.querySelector('.equipment-id');
    if (equipmentIdInput) {
        const eqId = parseInt(equipmentIdInput.value);
        equipmentIds.push(eqId);
        // 添加设备ID属性到卡片元素
        card.setAttribute('data-equipment-id', eqId);
        console.log(`设备${index+1}的ID：`, eqId);
    } else {
        console.error(`设备${index+1}没有找到设备ID隐藏字段`);
    }
});

console.log('提取到的设备ID列表：', equipmentIds);

// 简化的心跳发送函数
function sendHeartbeatForAllEquipments() {
    if (equipmentIds.length === 0) {
        console.error('没有找到设备ID，无法发送心跳！');
        return;
    }
    
    console.log('发送心跳：', equipmentIds);
    
    // 为每个设备发送心跳
    equipmentIds.forEach(equipmentId => {
        socket.emit('equipment_heartbeat', equipmentId);
        console.log(`发送心跳: 设备 ${equipmentId}`);
    });
}

// 为所有设备定期发送心跳（每10秒一次，更频繁地测试）
setInterval(sendHeartbeatForAllEquipments, 10000);

// 接收心跳响应
socket.on('heartbeat_response', (data) => {
    console.log(`心跳响应: 设备 ${data.equipment_id}`, data.status);
    // 更新设备卡片的最后心跳时间
    const card = [...cards].find(c => {
        const detailLink = c.querySelector('.btn-detail').getAttribute('href');
        const eqId = detailLink.match(/eq_id=(\d+)/)[1];
        return parseInt(eqId) === data.equipment_id;
    });
    if (card) {
        // 查找包含"最后心跳"的strong元素
        const strongElements = card.querySelectorAll('strong');
        let heartbeatStrong;
        for (const strong of strongElements) {
            if (strong.textContent.includes('最后心跳')) {
                heartbeatStrong = strong;
                break;
            }
        }
        if (heartbeatStrong && heartbeatStrong.nextSibling) {
            const now = new Date();
            const formattedTime = now.toLocaleString('zh-CN');
            heartbeatStrong.nextSibling.nodeValue = ` ${formattedTime}`;
        }
    }
});

// 页面刷新前断开Socket.IO连接，避免连接错误
window.addEventListener('beforeunload', () => {
    if (socket && socket.connected) {
        socket.disconnect();
        console.log('页面刷新前断开Socket.IO连接');
    }
});

// 定时刷新页面（每分钟一次）
setInterval(() => {
    // 刷新前断开连接
    if (socket && socket.connected) {
        socket.disconnect();
    }
    window.location.reload();
}, 60000);
</script>
{% endblock %}